@page "/account/create"
@using Project.Web.Enums.Account
@attribute [Authorize]

@layout Components.Layout.MainLayout
@inject NavigationManager NavigationManager
@inject IAuthService AuthService
@inject CustomAuthenticationStateProvider AuthProvider
@inject IAccessTokenService AccessTokenService
@inject IAccountService AccountService
@inject ILogger<Create> Logger

<PageTitle>Log in</PageTitle>
<AuthGuard/>

<MudText Typo="Typo.h6" Align="Align.Left" Class="mb-2">
    Criar uma nova conta
</MudText>

<MudPaper Elevation="2" Class="pa-6 mx-auto">

    <div class="col-lg-12">
        @if (Errors.Any())
        {
            @foreach (var error in Errors)
            {
                <MudAlert Severity="Severity.Error" Dense="true" Class="my-1">@error</MudAlert>
            }
        }
        @if (!string.IsNullOrEmpty(MessageSuccess))
        {
            <MudAlert Severity="Severity.Success" Dense="true" Class="my-1">@MessageSuccess</MudAlert>
        }
    </div>

    <EditForm Model="Input" OnValidSubmit="CreateAccountAsync">
        <DataAnnotationsValidator />

        <MudGrid >            

            <MudItem xs="12" md="4">
                <MudTextField Label="Email"
                              For="@(() => Input.Email)"
                              @bind-Value="Input.Email"
                              Variant="Variant.Text"
                              FullWidth="true" />
            </MudItem>

            <MudItem xs="12" md="4">
                <MudSelect T="Roles"
                           Label="Tipo"
                           @bind-Value="Input.Role"
                           Variant="Variant.Text"
                           FullWidth="true">
                    @foreach (Roles role in Enum.GetValues(typeof(Roles)).Cast<Roles>().OrderBy(r => r.GetDescription()))
                    {
                        <MudSelectItem T="Roles" Value="@role">@role.GetDescription()</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>

            <MudItem xs="12" md="4">
                <MudSelect T="AccountTypes"
                           Label="Acesso"
                           @bind-Value="Input.AccountType"
                           Variant="Variant.Text"
                           FullWidth="true">
                    @foreach (AccountTypes account in Enum.GetValues(typeof(AccountTypes)).Cast<AccountTypes>().OrderBy(r => r.GetDescription()))
                    {
                        <MudSelectItem T="AccountTypes" Value="@account">@account.GetDescription()</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>

            <MudItem xs="12" md="3">
                <MudTextField Label="Senha"
                              For="@(() => Input.Password)"
                              @bind-Value="Input.Password"
                              InputType="InputType.Password"
                              Variant="Variant.Text"
                              FullWidth="true" />
            </MudItem>

            <MudItem xs="12" md="3">
                <MudTextField Label="Confirme a Senha"
                              For="@(() => Input.ConfirmPassword)"
                              @bind-Value="Input.ConfirmPassword"
                              InputType="InputType.Password"
                              Variant="Variant.Text"
                              FullWidth="true" />
            </MudItem>

            <MudItem xs="12" Class="mt-4 d-flex justify-end">
                <MudButton ButtonType="ButtonType.Submit" 
                           Color="Color.Default"
                           Style="text-transform: none; transition: 0.2s ease-in-out;"
                           OnClick="HandleClick">
                    Voltar
                </MudButton>

                <MudButton Color="Color.Primary"
                           Disabled="@isLoading"
                           Style="text-transform: none; transition: 0.2s ease-in-out;"
                           ButtonType="ButtonType.Submit">
                    @if (isLoading)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                    }
                    else
                    {
                        <span>Salvar</span>
                    }
                </MudButton>
                
            </MudItem>
        </MudGrid>
    </EditForm>

</MudPaper>

@code {
    private bool isLoading = false;
    private readonly List<string> Errors = new List<string>();
    private string MessageSuccess;

    private InputModel Input { get; set; } = new();

    public async Task CreateAccountAsync()
    {
        try
        {
            MessageSuccess = string.Empty;
            isLoading = true;
            Errors.Clear();

            var response = await AccountService.CreateAsync(Input.Email, Input.Password, Input.Role.ToString(), Input.AccountType.ToString());
            if (!response.IsSuccess)
            {
                Errors.AddRange(response.Errors);
                return;
            }

            if (!string.IsNullOrEmpty(response?.Data?.Id))
            {
                MessageSuccess = "Conta criada com sucesso.";
                Input = new();
            }
        }
        catch (Exception ex)
        {
            Errors.Add("Falha ao criar a conta: " + ex.Message);
            Logger.LogError(ex, "An error occurred in the method CreateAccountAsync.");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void HandleClick()
    {
        NavigationManager.NavigateTo("/accounts", false);
    }

    private sealed class InputModel
    {
        [Required(ErrorMessage = "*Obrigatório")]
        [EmailAddress(ErrorMessage = "E-mail informado é inválido!")]
        public string Email { get; set; }

        [Required(ErrorMessage = "*Obrigatório")]
        [DataType(DataType.Password)]
        public string Password { get; set; }

        [Required(ErrorMessage = "*Obrigatório")]
        [DataType(DataType.Password)]
        [Compare("Password", ErrorMessage = "As senhas não coincidem.")]
        public string ConfirmPassword { get; set; }

        [Required(ErrorMessage = "*Obrigatório")]
        public Roles Role { get; set; }

        [Required(ErrorMessage = "*Obrigatório")]
        public AccountTypes AccountType { get; set; }
    }
}