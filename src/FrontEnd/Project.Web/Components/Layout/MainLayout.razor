@inherits LayoutComponentBase

@inject IAccessTokenService AccessTokenService
@inject NavigationManager Navigation
@inject CustomAuthenticationStateProvider AuthProvider
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager NavigationManager
@inject ICookieService CookieService

@if (_isAuthorization)
{
    <MudThemeProvider @bind-IsDarkMode="_isDarkMode" />
    <MudPopoverProvider />
    <MudDialogProvider />
    <MudSnackbarProvider />
    <MudLayout>
        <MudAppBar Elevation="1" Dense="true">
            <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" OnClick="@ToggleDrawer" Edge="Edge.Start" />
            <MudText Typo="Typo.h6" Class="ml-2">Projeto Blazor MudJWT</MudText>
            <MudSpacer />

            <MudIconButton Icon="@(DarkLightModeButtonIcon)" Color="Color.Inherit" OnClick="@DarkModeToggle" />

            <MudMenu Icon="@Icons.Material.Filled.Settings"
                     Color="Color.Inherit"
                     Dense="true"
                     AnchorOrigin="Origin.TopRight"
                     TransformOrigin="Origin.TopRight">
                <MudMenuItem OnClick="HandleProfileClick">Perfil</MudMenuItem>
                <MudMenuItem >Configurações</MudMenuItem>
                <MudMenuItem OnClick="Logout">Sair</MudMenuItem>
            </MudMenu>
            
        </MudAppBar>

        <MudDrawer @bind-Open="_drawerOpen" Elevation="1" ClipMode="DrawerClipMode.Always">
            <NavMenu />
        </MudDrawer>

        <MudMainContent Class="mt-4 px-4">
            @Body
        </MudMainContent>
    </MudLayout>
}

@code {
    private bool _isDarkMode = false;
    private string _themeDefault = "Light";
    private bool _drawerOpen = true;
    private bool _isAuthorization { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated ?? false)
        {
            _isAuthorization = true;
        }
        else
        {
            _isAuthorization = false;
            Navigation.NavigateTo("/auth/login");
        }

        var themeCookie = await CookieService.GetAsync("theme");
        if (themeCookie is null)
        {
            themeCookie = _themeDefault;
            await CookieService.SetAsync("theme", themeCookie, 365);
        }

        _isDarkMode = themeCookie != _themeDefault;
    }

    private void ToggleDrawer()
    {
        _drawerOpen = !_drawerOpen;
    }

    private async Task DarkModeToggle()
    {
        _isDarkMode = !_isDarkMode;

        var theme = _isDarkMode ? "Dark" : _themeDefault;
        await CookieService.RemoveAsync("theme");
        await CookieService.SetAsync("theme", theme, 365);
        
    }

    public string DarkLightModeButtonIcon => _isDarkMode switch
    {
        true => Icons.Material.Rounded.AutoMode,
        false => Icons.Material.Outlined.DarkMode,
    };

    private async Task Logout()
    {
        AuthProvider.MarkUserAsLoggedOut();
        await AccessTokenService.RemoveTokenAsync();

        Navigation.NavigateTo("/auth/login");
    }

    private void HandleProfileClick()
    {
        NavigationManager.NavigateTo("user/profile", false);
    }
}
